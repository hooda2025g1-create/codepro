<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø² - Ø­ÙˆØ¯Ø§</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .verify-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            padding: 40px;
            text-align: center;
            animation: fadeInUp 0.5s ease;
        }
        .verify-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        .icon-success {
            color: #2ed573;
        }
        .icon-waiting {
            color: #667eea;
        }
        .verify-title {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #333;
        }
        .verify-subtitle {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .phone-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.2rem;
            color: #333;
        }
        .otp-inputs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
        }
        .otp-input {
            width: 60px;
            height: 70px;
            font-size: 2rem;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: all 0.3s;
        }
        .otp-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }
        .verify-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 18px;
            font-size: 1.1rem;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            margin-top: 20px;
        }
        .verify-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .verify-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            border-left: 5px solid #2ed573;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border-left: 5px solid #ff4757;
        }
        .back-link {
            margin-top: 25px;
        }
        .back-link a {
            color: #667eea;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        @keyframes fadeInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
    </style>
</head>
<body>
    <div class="verify-container">
        <div class="verify-icon icon-waiting" id="verifyIcon">
            <i class="fas fa-shield-alt"></i>
        </div>
        
        <h1 class="verify-title" id="verifyTitle">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</h1>
        <p class="verify-subtitle" id="verifySubtitle">
            Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø°ÙŠ ÙˆØµÙ„Ùƒ Ø¹Ø¨Ø± WhatsApp
        </p>
        
        <div class="phone-display">
            <i class="fas fa-phone"></i>
            <span id="phoneNumber">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„...</span>
        </div>
        
        <div class="otp-inputs" id="otpInputs">
            <input type="number" class="otp-input" maxlength="1" data-index="0" oninput="moveToNext(this)">
            <input type="number" class="otp-input" maxlength="1" data-index="1" oninput="moveToNext(this)">
            <input type="number" class="otp-input" maxlength="1" data-index="2" oninput="moveToNext(this)">
            <input type="number" class="otp-input" maxlength="1" data-index="3" oninput="moveToNext(this)">
            <input type="number" class="otp-input" maxlength="1" data-index="4" oninput="moveToNext(this)">
            <input type="number" class="otp-input" maxlength="1" data-index="5" oninput="moveToNext(this)">
        </div>
        
        <div class="message success-message" id="successMessage">
            <i class="fas fa-check-circle"></i>
            <strong>ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­!</strong> Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø±Ø±...
        </div>
        
        <div class="message error-message" id="errorMessage">
            <i class="fas fa-times-circle"></i>
            <strong>Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­!</strong> ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù…Ø² ÙˆØ£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.
        </div>
        
        <button class="verify-btn" id="verifyBtn" onclick="verifyOTP()">
            <i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø²
        </button>
        
        <div class="back-link">
            <a href="#" onclick="resendOTP()">
                <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²
            </a>
            <span style="margin: 0 10px; color: #ccc;">|</span>
            <a href="4_send_otp.html">
                <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            </a>
        </div>
    </div>

    <script>
        // Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
        const userPhone = localStorage.getItem('user_phone') || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        document.getElementById('phoneNumber').textContent = userPhone;
        
        // Ù†Ù‚Ù„ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¨ÙŠÙ† Ù…Ø±Ø¨Ø¹Ø§Øª OTP
        function moveToNext(input) {
            const value = input.value;
            const index = parseInt(input.dataset.index);
            
            // Ø¥Ø°Ø§ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±Ù‚Ù…ØŒ Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªØ§Ù„ÙŠ
            if (value.length === 1 && index < 5) {
                const nextInput = document.querySelector(`.otp-input[data-index="${index + 1}"]`);
                nextInput.focus();
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙØ§Ø±ØºØ§Ù‹ ÙˆØ¶ØºØ· backspaceØŒ Ø§Ø±Ø¬Ø¹ Ù„Ù„Ø®Ù„Ù
            if (value.length === 0 && index > 0 && event.inputType === 'deleteContentBackward') {
                const prevInput = document.querySelector(`.otp-input[data-index="${index - 1}"]`);
                prevInput.focus();
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª
            if (index === 5 && value.length === 1) {
                const otpCode = getOTPFromInputs();
                if (otpCode.length === 6) {
                    // ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù‡Ù†Ø§
                    // verifyOTP();
                }
            }
        }
        
        // Ø¬Ù…Ø¹ OTP Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        function getOTPFromInputs() {
            let otp = '';
            for (let i = 0; i < 6; i++) {
                const input = document.querySelector(`.otp-input[data-index="${i}"]`);
                otp += input.value || '';
            }
            return otp;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† OTP
        async function verifyOTP() {
            const enteredOTP = getOTPFromInputs();
            const pendingOTP = localStorage.getItem('pending_otp');
            
            // ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
            verifyBtn.disabled = true;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            // ØªØ£Ø®ÙŠØ± Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…
            setTimeout(async () => {
                if (enteredOTP.length !== 6) {
                    showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø³ØªØ©');
                    resetButton();
                    return;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ OTP
                if (enteredOTP === pendingOTP) {
                    // âœ… Ø§Ù„Ù†Ø¬Ø§Ø­
                    await markUserAsVerified();
                    showSuccess();
                } else {
                    // âŒ Ø§Ù„ÙØ´Ù„
                    showError('Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­');
                    shakeInputs();
                }
            }, 1000);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Supabase
        async function markUserAsVerified() {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ 
                        is_verified: true,
                        verified_at: new Date().toISOString()
                    })
                    .eq('phone', userPhone);
                
                if (error) throw error;
                console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
            }
        }
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        function showSuccess() {
            const verifyIcon = document.getElementById('verifyIcon');
            const verifyTitle = document.getElementById('verifyTitle');
            const verifySubtitle = document.getElementById('verifySubtitle');
            const successMessage = document.getElementById('successMessage');
            
            // ØªØºÙŠÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
            verifyIcon.className = 'verify-icon icon-success';
            verifyIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            
            // ØªØºÙŠÙŠØ± Ø§Ù„Ù†ØµÙˆØµ
            verifyTitle.textContent = 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­!';
            verifySubtitle.textContent = 'Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù…Ø¤ÙƒØ¯ Ø§Ù„Ø¢Ù†';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
            successMessage.style.display = 'block';
            
            // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚
            localStorage.setItem('user_verified', 'true');
            
            // Ø¥Ø®ÙØ§Ø¡ Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            document.getElementById('otpInputs').style.opacity = '0.5';
            document.getElementById('verifyBtn').style.display = 'none';
            
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø­Ø±Ø± Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
            setTimeout(() => {
                window.location.href = '3_editor.html';
            }, 3000);
        }
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.innerHTML = `<i class="fas fa-times-circle"></i> <strong>${message}</strong>`;
            errorMessage.style.display = 'block';
            resetButton();
        }
        
        // Ù‡Ø² Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£
        function shakeInputs() {
            const inputs = document.querySelectorAll('.otp-input');
            inputs.forEach(input => {
                input.classList.add('shake');
                setTimeout(() => {
                    input.classList.remove('shake');
                }, 500);
            });
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø²Ø±
        function resetButton() {
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.innerHTML = '<i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø²';
            verifyBtn.disabled = false;
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ OTP
        function resendOTP() {
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² ØªØ­Ù‚Ù‚ Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ù‡Ø§ØªÙÙƒ');
            
            // ØªÙˆÙ„ÙŠØ¯ OTP Ø¬Ø¯ÙŠØ¯
            const newOTP = Math.floor(100000 + Math.random() * 900000).toString();
            localStorage.setItem('pending_otp', newOTP);
            
            // ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            updateOTPInDatabase(newOTP);
        }
        
        async function updateOTPInDatabase(otp) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ otp_code: otp })
                    .eq('phone', userPhone);
                
                if (error) throw error;
                console.log('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« OTP ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« OTP:', error);
            }
        }
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        document.addEventListener('DOMContentLoaded', function() {
            // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£ÙˆÙ„
            document.querySelector('.otp-input[data-index="0"]').focus();
            
            // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù„ØµÙ‚ OTP ÙƒØ§Ù…Ù„
            document.addEventListener('paste', function(e) {
                const pastedData = e.clipboardData.getData('text');
                if (pastedData.length === 6 && /^\d+$/.test(pastedData)) {
                    const inputs = document.querySelectorAll('.otp-input');
                    inputs.forEach((input, index) => {
                        input.value = pastedData[index] || '';
                    });
                    e.preventDefault();
                    
                    // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø®ÙŠØ±
                    document.querySelector('.otp-input[data-index="5"]').focus();
                }
            });
        });
    </script>
</body>
</html>