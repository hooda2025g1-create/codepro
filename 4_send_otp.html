<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ - Ø­ÙˆØ¯Ø§</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .otp-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            padding: 40px;
            text-align: center;
            animation: fadeInUp 0.5s ease;
        }
        .otp-icon {
            font-size: 80px;
            color: #667eea;
            margin-bottom: 20px;
        }
        .otp-title {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #333;
        }
        .otp-subtitle {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .phone-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
        .whatsapp-notice {
            background: #25D366;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .otp-code-display {
            background: #fffbeb;
            border: 2px dashed #f59e0b;
            padding: 20px;
            border-radius: 10px;
            margin: 25px 0;
            font-family: 'Courier New', monospace;
            font-size: 2.5rem;
            letter-spacing: 10px;
            color: #333;
        }
        .otp-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        .otp-btn {
            flex: 1;
            padding: 18px;
            border-radius: 10px;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
            border: 2px solid #cbd5e1;
        }
        .otp-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .timer {
            font-size: 1.2rem;
            color: #666;
            margin-top: 20px;
        }
        .timer-number {
            color: #ef4444;
            font-weight: bold;
        }
        @keyframes fadeInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="otp-container">
        <div class="otp-icon">
            <i class="fas fa-sms"></i>
        </div>
        
        <h1 class="otp-title">ØªØ£ÙƒÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</h1>
        <p class="otp-subtitle">
            ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² ØªØ­Ù‚Ù‚ Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù… Ø¥Ù„Ù‰ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ù…Ø³Ø¬Ù„
        </p>
        
        <div class="phone-display">
            <i class="fas fa-phone"></i>
            <span id="phoneNumber">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„...</span>
        </div>
        
        <div class="whatsapp-notice">
            <i class="fab fa-whatsapp"></i>
            <span>ØªØ£ÙƒØ¯ Ø£Ù† WhatsApp Ù…ÙØªÙˆØ­ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…</span>
        </div>
        
        <div class="otp-code-display" id="otpDisplay">
            000000
        </div>
        
        <div class="timer">
            <i class="fas fa-clock"></i>
            Ø§Ù„Ø±Ù…Ø² ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø©: <span class="timer-number" id="timer">05:00</span> Ø¯Ù‚ÙŠÙ‚Ø©
        </div>
        
        <div class="otp-actions">
            <button class="otp-btn btn-primary" onclick="goToVerify()">
                <i class="fas fa-check-circle"></i> ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ù…Ø²ØŒ ØªØ§Ø¨Ø¹
            </button>
            
            <button class="otp-btn btn-secondary" onclick="resendOTP()">
                <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„
            </button>
        </div>
        
        <div id="resendMessage" class="hidden" style="color:#2ed573; margin-top:15px;">
            âœ“ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯
        </div>
    </div>

    <script>
        // Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† localStorage
        const userPhone = localStorage.getItem('user_phone') || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        document.getElementById('phoneNumber').textContent = userPhone;
        
        // ØªÙˆÙ„ÙŠØ¯ OTP Ø¬Ø¯ÙŠØ¯ ÙˆØ­ÙØ¸Ù‡
        let currentOTP = '';
        
        function generateOTP() {
            currentOTP = Math.floor(100000 + Math.random() * 900000).toString();
            document.getElementById('otpDisplay').textContent = currentOTP;
            
            // Ø­ÙØ¸ OTP ÙÙŠ Supabase
            saveOTPToDatabase(currentOTP);
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
            startTimer(5 * 60); // 5 Ø¯Ù‚Ø§Ø¦Ù‚
            
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø±Ø³Ø§Ù„ OTP Ø¹Ø¨Ø± WhatsApp
            simulateWhatsAppSend(currentOTP);
        }
        
        function saveOTPToDatabase(otp) {
            // ØªØ­Ø¯ÙŠØ« OTP ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const updateOTP = async () => {
                const { error } = await supabase
                    .from('users')
                    .update({ otp_code: otp })
                    .eq('phone', userPhone);
                
                if (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ OTP:', error);
                } else {
                    console.log('âœ… ØªÙ… Ø­ÙØ¸ OTP ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }
            };
            updateOTP();
        }
        
        function simulateWhatsAppSend(otp) {
            console.log(`ğŸ“± [Ù…Ø­Ø§ÙƒØ§Ø©] ØªÙ… Ø¥Ø±Ø³Ø§Ù„ OTP Ø¥Ù„Ù‰ ${userPhone}: ${otp}`);
            console.log('ğŸ’¡ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ: Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø¯Ù…Ø© Ù…Ø«Ù„ Twilio Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙØ¹Ù„ÙŠØ©');
        }
        
        // Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
        let timerInterval;
        function startTimer(seconds) {
            clearInterval(timerInterval);
            
            const timerElement = document.getElementById('timer');
            let timeLeft = seconds;
            
            timerInterval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerElement.textContent = "00:00";
                    timerElement.style.color = "#ef4444";
                    // ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ§Ø¨Ø¹
                }
                
                timeLeft--;
            }, 1000);
        }
        
        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ­Ù‚Ù‚
        function goToVerify() {
            // Ø­ÙØ¸ OTP ÙÙŠ localStorage Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
            localStorage.setItem('pending_otp', currentOTP);
            window.location.href = '5_verify_otp.html';
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ OTP
        function resendOTP() {
            generateOTP();
            document.getElementById('resendMessage').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('resendMessage').classList.add('hidden');
            }, 3000);
        }
        
        // ØªÙˆÙ„ÙŠØ¯ OTP Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        generateOTP();
    </script>
</body>
</html>